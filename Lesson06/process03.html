<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Lesson06 - 00 | コードを分割して整理する</title>
  <style>
    body { margin: 0; overflow: hidden; }
  </style>
</head>
<body>
  <!-- canvas要素を用意 -->
  <canvas id="canvas"></canvas>
  <!-- Three.js をCDNから読み込む -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.164.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.164.0/examples/jsm/"
    }
  }
  </script>

  <script type="module">
  import { setupThreeEnvironment } from '../three/three-setup.js';
  import { setupPointerLockControls } from '../three/pointer-lock.js';
  import { setupMovement } from '../three/movement.js';
  import * as THREE from 'three';
  import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";

  // 基本オブジェクト一式
  const canvas = document.querySelector("#canvas");
  const { renderer, scene, camera } = setupThreeEnvironment(canvas);

  // PointerLockControls
  const { controls, isLockedRef } = setupPointerLockControls(camera, renderer.domElement);

  // Movement
  const movement = setupMovement(camera);

  // GLTF形式のモデルデータを読み込む
  const loader = new GLTFLoader();
  // GLTFファイルのパスを指定
  const gltf = await loader.loadAsync('./sample.gltf');
  // 読み込み後に3D空間に追加
  const model = gltf.scene;

  // モデルの設定
  model.traverse((node) => {
    if (node instanceof THREE.Mesh) {
      node.material.side = THREE.DoubleSide;
      node.castShadow = true;
      node.receiveShadow = true;
    }
  });
  model.position.set(0, 5, 0);
  model.scale.set(5, 5, 5);
  scene.add(model);

  // 毎フレーム呼ばれるループ処理
  function tick() {
    // pointer-lock.js 側の状態を見る
    if (isLockedRef()) {
      // movement.js 側で計算した移動ベクトルをカメラに反映
      const dir = movement.getMovementVector();
      camera.position.add(dir);
    }

    renderer.render(scene, camera);
    requestAnimationFrame(tick);
  }

  // Start!!
  tick();

</script>
</body>
</html>
